{% extends 'base.html' %}

{% block title %}Consolidador T25{% endblock %}
{% block page_title %}Consolidador T25{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center space-x-3 mb-4">
            <i data-feather="layers" class="w-8 h-8 text-indigo-600"></i>
            <h2 class="text-3xl font-bold text-neutral-900">Consolidador T25</h2>
        </div>
        <p class="text-neutral-600">Sistema automatizado para consolidar ANEXO 1 desde GoAnywhere</p>
    </div>

    <!-- Estado de conexión -->
    <div class="card-gradient rounded-2xl border border-neutral-100 p-6 mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center">
                    <i data-feather="server" class="w-6 h-6 text-indigo-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-neutral-900">Conexión GoAnywhere</h3>
                    <div class="flex items-center space-x-2 mt-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full" id="status-dot"></div>
                        <span class="text-sm text-neutral-600" id="status-label">Desconectado</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleConexion()" id="connect-btn" class="px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 transition-smooth font-semibold">
                <i data-feather="wifi" class="w-5 h-5 inline mr-2"></i>
                <span id="connect-text">Conectar</span>
            </button>
        </div>
    </div>

    <!-- Opciones principales -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        
        <!-- Opción 1: Gestión de Maestra -->
        <a href="{{ url_for('consolidador_t25.maestra') }}" class="card-gradient rounded-2xl border border-neutral-100 p-6 hover-lift transition-smooth group">
            <div class="flex items-center justify-between mb-4">
                <div class="w-14 h-14 bg-gradient-to-br from-blue-100 to-blue-50 rounded-xl flex items-center justify-center">
                    <i data-feather="database" class="w-7 h-7 text-blue-600"></i>
                </div>
                <div class="w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center group-hover:bg-blue-500 transition-smooth">
                    <i data-feather="arrow-right" class="w-4 h-4 text-neutral-400 group-hover:text-white"></i>
                </div>
            </div>
            <h4 class="text-lg font-semibold text-neutral-900 mb-2">Gestión de Maestra</h4>
            <p class="text-sm text-neutral-600 mb-4">
                Administrar archivo maestra de contratos vigentes
            </p>
            <div class="flex items-center text-sm text-blue-600 font-medium">
                <span>Administrar</span>
            </div>
        </a>

        <!-- Opción 2: Buscar Contrato -->
        <a href="{{ url_for('consolidador_t25.buscar_contrato_page') }}" class="card-gradient rounded-2xl border border-neutral-100 p-6 hover-lift transition-smooth group">
            <div class="flex items-center justify-between mb-4">
                <div class="w-14 h-14 bg-gradient-to-br from-green-100 to-green-50 rounded-xl flex items-center justify-center">
                    <i data-feather="search" class="w-7 h-7 text-green-600"></i>
                </div>
                <div class="w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center group-hover:bg-green-500 transition-smooth">
                    <i data-feather="arrow-right" class="w-4 h-4 text-neutral-400 group-hover:text-white"></i>
                </div>
            </div>
            <h4 class="text-lg font-semibold text-neutral-900 mb-2">Buscar Contrato</h4>
            <p class="text-sm text-neutral-600 mb-4">
                Procesar un contrato individual específico
            </p>
            <div class="flex items-center text-sm text-green-600 font-medium">
                <span>Buscar</span>
            </div>
        </a>

        <!-- Opción 3: Consolidado Masivo -->
        <a href="{{ url_for('consolidador_t25.consolidar_masivo_page') }}" class="card-gradient rounded-2xl border border-neutral-100 p-6 hover-lift transition-smooth group">
            <div class="flex items-center justify-between mb-4">
                <div class="w-14 h-14 bg-gradient-to-br from-orange-100 to-orange-50 rounded-xl flex items-center justify-center">
                    <i data-feather="layers" class="w-7 h-7 text-orange-600"></i>
                </div>
                <div class="w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center group-hover:bg-orange-500 transition-smooth">
                    <i data-feather="arrow-right" class="w-4 h-4 text-neutral-400 group-hover:text-white"></i>
                </div>
            </div>
            <h4 class="text-lg font-semibold text-neutral-900 mb-2">Consolidado Masivo</h4>
            <p class="text-sm text-neutral-600 mb-4">
                Procesar todos los contratos de un año
            </p>
            <div class="flex items-center text-sm text-orange-600 font-medium">
                <span>Consolidar</span>
            </div>
        </a>

    </div>

    <!-- Información del sistema -->
    <div class="card-gradient rounded-2xl border border-neutral-100 p-6">
        <div class="flex items-start space-x-4">
            <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <i data-feather="info" class="w-5 h-5 text-indigo-600"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-neutral-900 mb-3">¿Cómo funciona el Consolidador T25?</h3>
                
                <div class="space-y-3 text-sm text-neutral-600">
                    <div class="flex items-start space-x-2">
                        <span class="font-semibold text-blue-600 mt-0.5">1.</span>
                        <p><strong>Gestión de Maestra:</strong> Sube y mantén actualizada la maestra de contratos vigentes (actualización semanal)</p>
                    </div>
                    
                    <div class="flex items-start space-x-2">
                        <span class="font-semibold text-green-600 mt-0.5">2.</span>
                        <p><strong>Buscar Contrato:</strong> Busca y procesa un contrato específico individual</p>
                    </div>
                    
                    <div class="flex items-start space-x-2">
                        <span class="font-semibold text-orange-600 mt-0.5">3.</span>
                        <p><strong>Consolidado Masivo:</strong> Procesa todos los contratos de un año automáticamente</p>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-start space-x-2">
                        <i data-feather="alert-circle" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"></i>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">Importante:</p>
                            <p>Antes de usar el consolidador, asegúrate de:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                <li>Tener la maestra actualizada</li>
                                <li>Estar conectado a GoAnywhere</li>
                                <li>Verificar los permisos de acceso</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
let isConnected = false;

// Verificar estado al cargar
document.addEventListener('DOMContentLoaded', function() {
    verificarEstadoConexion();
});

async function verificarEstadoConexion() {
    try {
        const response = await fetch('/modulos/consolidador-t25/estado');
        const data = await response.json();
        
        if (data.conectado) {
            isConnected = true;
            actualizarUIConectado();
        }
    } catch (error) {
        console.log('No hay conexión activa');
    }
}

async function toggleConexion() {
    if (isConnected) {
        await desconectar();
    } else {
        await conectar();
    }
}

async function conectar() {
    const connectBtn = document.getElementById('connect-btn');
    const statusDot = document.getElementById('status-dot');
    const statusLabel = document.getElementById('status-label');
    
    connectBtn.disabled = true;
    connectBtn.innerHTML = '<i data-feather="loader" class="w-5 h-5 inline mr-2 animate-spin"></i>Conectando...';
    feather.replace();
    
    statusLabel.textContent = 'Conectando...';
    statusDot.className = 'w-2 h-2 bg-yellow-400 rounded-full animate-pulse';
    
    try {
        const response = await fetch('/modulos/consolidador-t25/conectar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            isConnected = true;
            showNotification('✅ Conectado a GoAnywhere exitosamente', 'success');
            actualizarUIConectado();
        } else {
            showNotification('❌ Error al conectar: ' + data.error, 'error');
            resetearUI();
        }
        
    } catch (error) {
        showNotification('Error de conexión: ' + error.message, 'error');
        resetearUI();
    }
}

async function desconectar() {
    try {
        await fetch('/modulos/consolidador-t25/desconectar', {
            method: 'POST'
        });
        
        isConnected = false;
        showNotification('Desconectado de GoAnywhere', 'info');
        resetearUI();
        
    } catch (error) {
        console.error('Error al desconectar:', error);
    }
}

function actualizarUIConectado() {
    const statusDot = document.getElementById('status-dot');
    const statusLabel = document.getElementById('status-label');
    const connectBtn = document.getElementById('connect-btn');
    
    statusLabel.textContent = 'Conectado';
    statusDot.className = 'w-2 h-2 bg-green-400 rounded-full';
    
    connectBtn.innerHTML = '<i data-feather="wifi-off" class="w-5 h-5 inline mr-2"></i>Desconectar';
    connectBtn.disabled = false;
    connectBtn.className = 'px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-smooth font-semibold';
    
    feather.replace();
}

function resetearUI() {
    const statusDot = document.getElementById('status-dot');
    const statusLabel = document.getElementById('status-label');
    const connectBtn = document.getElementById('connect-btn');
    
    statusLabel.textContent = 'Desconectado';
    statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full';
    
    connectBtn.innerHTML = '<i data-feather="wifi" class="w-5 h-5 inline mr-2"></i>Conectar';
    connectBtn.disabled = false;
    connectBtn.className = 'px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 transition-smooth font-semibold';
    
    feather.replace();
}
</script>
{% endblock %}